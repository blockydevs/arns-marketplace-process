name: 'Tests'

on:
    workflow_dispatch:
    pull_request:

permissions:
    contents: read
    packages: read

jobs:
    unit:
        runs-on: ubuntu-24.04
        timeout-minutes: 10
        steps:
            -   name: Check out repository code
                uses: actions/checkout@v4

            -   name: Setup Lua
                uses: leafo/gh-actions-lua@v10
                with:
                    luaVersion: '5.3'

            -   name: Setup LuaRocks
                uses: leafo/gh-actions-luarocks@v4.3.0

            -   name: Install Lua dependencies
                run: |
                    luarocks make --only-deps arns-marketplace-process-0.1.0-1.rockspec

            -   name: Run all tests
                if: ${{ always() }}
                run: |
                    set -e
                    cd tests
                    # Run tests.lua first if present
                    if [ -f tests.lua ]; then
                      echo "==> lua tests.lua"
                      lua tests.lua
                    fi
                    # Run all *_tests.lua recursively, sorted
                    find . -type f -name '*_tests.lua' | sort | while read -r tf; do
                      echo "==> lua $tf"
                      lua "$tf"
                    done